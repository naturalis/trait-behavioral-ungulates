---
title: "How does ecology predict ungulate traits"
author: "yuxin wei"
date: "2021/4/12"
output: 
  html_document: default
  pdf_document: default
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
```

# 1 Import data
Our first step is to import packages and data into R. The trait data and OMI data also need to be merged.

### Load packages
```{r Load packages, message=FALSE}
library(ape)
library(dplyr)
library(usdm)
library(caret)
library(corrplot)
library(phylolm)
library(performance)
library(see)
library(gridExtra)
```

### Import data
The datasets can be found in different GitHub repositories. The ungulate
dataset and tree can be found in the trait-organismal-ungulates repository. 
The OMI data is found in the trait-geo-diverse-ungulates repository.
```{r import data}
ungulatesData <- read.csv("https://raw.githubusercontent.com/naturalis/trait-organismal-ungulates/master/data/CSV/ungulatesTraits.csv")
omi <- read.csv("https://raw.githubusercontent.com/naturalis/trait-geo-diverse-ungulates/master/results/OMI/niche_traits.csv")
tree <- read.tree("https://raw.githubusercontent.com/naturalis/trait-organismal-ungulates/master/data/phylogeny/ungulates.tree")
```

### Merge datasets
The ungulate data and OMI data have to be merged into one dataset. The EoL-ID is
removed and the data is merged by the canonical name (present in both the
datasets). The last step is to replace the spaces in the canonical name with
underscores, to match the species names in the tree.
```{r merge data}
ungulatesData <- ungulatesData[2:60]
names(omi)[names(omi)=="X"] <- "CanonicalName"
dataset <- merge(ungulatesData, omi, by="CanonicalName")
dataset$CanonicalName <- gsub(" ", "_", dataset$CanonicalName)
# Clean up the global environment 
rm(ungulatesData, omi)
```

# 2 Preprocessing
### Equalize species in tree and dataset
To start, 'Equus asinus' is renamed to the 'Equus africanus' in the tree, to
match the dataset. The species that aren't in the tree are dropped from the
dataset. The species that aren't in the dataset are dropped from the tree.
```{r check if names match between dataset and tree, results='hide'}
# Changed Equus asinus to Equus africanus in the tree 
tree$tip.label[tree$tip.label=="Equus_asinus"] <- "Equus_africanus"
# Check Which species aren't in the tree
dropRows <- setdiff(dataset$CanonicalName, tree$tip.label)
# Drop rows that aren't in the tree (check manually if these are domesticated)
row.names(dataset) <- dataset$CanonicalName
dataset <- dataset[!(row.names(dataset) %in% dropRows), ]
# Drop tips that aren't in dataset
dropTips <- setdiff(tree$tip.label, dataset$CanonicalName)
tree <- drop.tip(tree, dropTips)
# Final check to see if there are any differences
setdiff(dataset$CanonicalName, tree$tip.label)
setdiff(tree$tip.label, dataset$CanonicalName)
rm(dropRows, dropTips)
```

### Miscellaneous preprocessing
The dots in the column names are replaced with underscores. After that, the
traits that consist of more than 100 missing values, traits that have no
information gain and traits that are almost identical to other traits are
removed.
```{r misc preprocessing}
# Rename column with dots in the name
names(dataset)[names(dataset)=="X21.1_PopulationDensity_n.km2"] <- "X21.1_PopulationDensity_n_km2"
# Remove traits that (almost) only consist of missing values (>100 NA)
dataset <- subset(dataset, select = -c(X5.4_WeaningBodyMass_g, X13.3_WeaningHeadBodyLen_mm, X13.2_NeonateHeadBodyLen_mm, X18.1_BasalMetRate_mLO2hr, X5.2_BasalMetRateMass_g, X2.1_AgeatEyeOpening_d, X8.1_AdultForearmLen_mm, X10.1_PopulationGrpSize))
# Remove traits without any information gain (only consist of one value)
dataset <- subset(dataset, select = -c(Motility, ParentalCare, X12.2_Terrestriality))
# Remove traits that are almost identical to other traits
dataset <- subset(dataset, select = -c(PullStrength, NumOffspring, BreedingInterval, Diet, AVGWeight, MaturityReachFemale, MaturityReachMale, X22.2_HomeRange_Indiv_km2, X5.3_NeonateBodyMass_g, X16.1_LittersPerYear,X7.1_DispersalAge_d))
```

### Set as factors
Some of the columns are not seen as categorical, but as numeric. These must be converted
to factors.
```{r as factor}
dataset$Domestication <- as.factor(dataset$Domestication)
dataset$X1.1_ActivityCycle <- as.factor(dataset$X1.1_ActivityCycle)
dataset$X6.1_DietBreadth <- as.factor(dataset$X6.1_DietBreadth)
dataset$X12.1_HabitatBreadth <- as.factor(dataset$X12.1_HabitatBreadth)
dataset$X6.2_TrophicLevel <- as.factor(dataset$X6.2_TrophicLevel)
dataset$Sociality <- as.factor(dataset$Sociality)
dataset$SocialHierarchy <- as.factor(dataset$SocialHierarchy)
dataset$NumMales <- as.factor(dataset$NumMales)
dataset$MatingSystem <- as.factor(dataset$MatingSystem)
dataset$YearRoundBreeding <- as.factor(dataset$YearRoundBreeding)
dataset$DevelopmentStrategy <- as.factor(dataset$DevelopmentStrategy)
dataset$HeadOrnaments <- as.factor(dataset$HeadOrnaments)
dataset$NaturalPredators <- as.factor(dataset$NaturalPredators)
```

### Split dataset
The aim of this research is to find out how does ecology predict ungulate traits. 
Thus, after data preprocessing, "dataset" should be split into two parts that contains the predictor variables and the dependent variables respectively. 
```{r re-divide the dataset}
ungulatesTraits <- dataset[, 1:37]
ecology <- dataset[, 38:78]
# write.table(ungulatesTraits,"ungulatesTraits.csv",row.names=TRUE,col.names=TRUE,sep=",")
```

# 3 VIF-Analysis
Colinearity means that there is redundancy among explanatory variables, which would lead to the results like unstable estimates. Here we use the variable inflation factor analysis (VIF) to remove the variables that are in high collinearity. The VIF_2.R script that contains the whole VIF analysis is sourced below. The final results store in the 'Predictors'.
```{r VIF, results='markup'}
# Do the VIF analysis
source("VIF_2.R")
# Final VIF values
vif(Predictors)
```

# 4 Model Selection
We choose Generalized Linear Model (GLM) to analyze the relationship between ungulate traits
and ecology variables. According to the result of VIF analysis, columns from "Predictor" are
used as independent variables. Take one column from "ungulatesTraits" at a time as the
dependent variable. For the model selection the phylolm package and phyloglmstep function are required.
```{r model selection, results='hide'}
# Extract the dependent variables to be studied 
Responser <- ungulatesTraits[c(7:37)]
# Find the factor variables with two levels and change the level '2' to '0', to meet the requirement of 'logistic' method.
levels(Responser$Domestication)[levels(Responser$Domestication)==2]<-0
levels(Responser$X12.1_HabitatBreadth)[levels(Responser$X12.1_HabitatBreadth)==2]<-0
levels(Responser$X6.2_TrophicLevel)[levels(Responser$X6.2_TrophicLevel)==2]<-0
levels(Responser$Sociality)[levels(Responser$Sociality)==2]<-0
levels(Responser$SocialHierarchy)[levels(Responser$SocialHierarchy)==2]<-0
levels(Responser$YearRoundBreeding)[levels(Responser$YearRoundBreeding)==2]<-0
levels(Responser$DevelopmentStrategy)[levels(Responser$DevelopmentStrategy)==2]<-0
levels(Responser$HeadOrnaments)[levels(Responser$HeadOrnaments)==2]<-0
# Divide the 'Responser' into three groups according to the types of variables: 'binaryData', 'multiData' and 'numData'.
binData <- subset(Responser,select = c("Domestication", "X12.1_HabitatBreadth", "X6.2_TrophicLevel", "Sociality", "SocialHierarchy", "YearRoundBreeding", "DevelopmentStrategy", "HeadOrnaments"))
multiData <- subset(Responser, select = c("X1.1_ActivityCycle", "MatingSystem", "NaturalPredators", "NumMales", "X6.1_DietBreadth"))
numData <- subset(Responser, select = -c(Domestication, X12.1_HabitatBreadth, X6.2_TrophicLevel, Sociality, SocialHierarchy, YearRoundBreeding, DevelopmentStrategy, HeadOrnaments, X1.1_ActivityCycle, MatingSystem, NaturalPredators, NumMales, X6.1_DietBreadth))


# Do the model selection   
source("Model_Selection_Num.R")
# source("Model_Selection_Factor_Multi.R")
source("Model_Selection_Factor_Binary.R")

#The final models stored in the documents are organized orderly into three new documents:"Formula_binary.txt", "Formula_multi.txt", "Formula_num.txt"

# Remove unneeded variables
# rm(Responser)
```

# 5 Modelling analysis 
The phylogenetic generalized linear modelling analysis optimizes the model. The function phyloglm/??? from the phylolm package is used for this.
```{r model analysis}
# Import documents that contain the formula for the model analysis
binFormulas <- read.table("Formula_binary.txt", sep = "\n")
multiFormulas <- read.table("Formula_multi.txt", sep = "\n")
numFormulas <- read.table("Formula_num.txt", sep = "\n")

source("Model_Analysis_Factor_Binary.R")
# source("Model_Analysis_Factor_Multi.R")
# source("Model_Analysis_Factor_Num.R")
```


# 6 Model evaluation 

